<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vlog-Orte</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{
  margin:0;
  font-family:system-ui, Arial;
  background:#0f0f10;
  color:#eaeaea;
}
header{
  padding:12px 14px;
  border-bottom:1px solid #2a2a2a;
  position:sticky;
  top:0;
  background:#0f0f10;
  z-index:10;
}
button{
  background:#1b1b1d;
  border:1px solid #2f2f33;
  color:#eaeaea;
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
}
.wrap{padding:12px;display:grid;gap:12px;}
.card{
  background:#151517;
  border:1px solid #2a2a2a;
  border-radius:18px;
  padding:12px;
}
#map{height:45vh;border-radius:14px;}
.small{color:#aaa;font-size:13px;}
.item{border-top:1px solid #2a2a2a;padding-top:8px;margin-top:8px;}
</style>
</head>

<body>

<header>
  <strong>Vlog-Orte</strong><br>
  <span class="small" id="status">bereit</span>
</header>

<div class="wrap">

  <div class="card">
    <button onclick="startTracking()">Tracking starten</button>
    <button onclick="stopTracking()">Stop</button>
  </div>

  <div id="map" class="card"></div>

  <div class="card">
    <strong>Gespeicherte Orte</strong>
    <div id="list"></div>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map=L.map('map').setView([48.8,12.3],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'© OpenStreetMap'
}).addTo(map);

let meMarker=null;
let watchId=null;
let anchor=null;

const STORAGE="vlog_orte";
let visits=JSON.parse(localStorage.getItem(STORAGE)||"[]");

function save(){
  localStorage.setItem(STORAGE,JSON.stringify(visits));
}

function distance(a,b,c,d){
  const R=6371000;
  const toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a);
  const dLon=toRad(d-b);
  const x=Math.sin(dLat/2)**2 +
          Math.cos(toRad(a))*Math.cos(toRad(c))*
          Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}

function render(){
  document.getElementById("list").innerHTML="";
  visits.forEach(v=>{
    let div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<strong>${v.title}</strong><br>
                   <span class="small">${new Date(v.time).toLocaleString()}</span>`;
    document.getElementById("list").appendChild(div);
    L.circleMarker([v.lat,v.lon]).addTo(map);
  });
}

async function storeStop(lat,lon){
  let url=`https://de.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}|${lon}&gsradius=1500&gslimit=1&format=json&origin=*`;
  let r=await fetch(url);
  let j=await r.json();
  let title=j.query.geosearch[0]?.title || "Interessanter Ort";

  visits.unshift({
    lat,lon,
    time:Date.now(),
    title
  });
  save();
  render();
}

function startTracking(){
  document.getElementById("status").innerText="Tracking läuft…";
  watchId=navigator.geolocation.watchPosition(pos=>{
    let {latitude:lat, longitude:lon, accuracy}=pos.coords;
    if(accuracy>80) return;

    if(!meMarker){
      meMarker=L.marker([lat,lon]).addTo(map);
      map.setView([lat,lon],15);
    }else{
      meMarker.setLatLng([lat,lon]);
    }

    let now=Date.now();
    if(!anchor){
      anchor={lat,lon,start:now};
      return;
    }

    let d=distance(anchor.lat,anchor.lon,lat,lon);

    if(d<120 && now-anchor.start>300000){
      storeStop(anchor.lat,anchor.lon);
      anchor={lat,lon,start:now};
    }

    if(d>120){
      anchor={lat,lon,start:now};
    }

  },err=>{
    alert("Standort nicht verfügbar");
  },{
    enableHighAccuracy:true,
    maximumAge:10000,
    timeout:10000
  });
}

function stopTracking(){
  if(watchId) navigator.geolocation.clearWatch(watchId);
  document.getElementById("status").innerText="gestoppt";
}

render();
</script>

</body>
</html>